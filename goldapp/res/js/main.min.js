const SUPABASE_URL="https://iwsacljessokrqhfmdbv.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3c2FjbGplc3Nva3JxaGZtZGJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxODcyNTMsImV4cCI6MjA4Mzc2MzI1M30.jQ_8KR76Xbbn1Heest75p3I78J6oiSt9V-H31cWWLOo",{createClient:createClient}=supabase,sbClient=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);let latestPricesMap=new Map,currentWalletId=null,currentWalletName="";function handleSessionSync(t){currentSessionUser=t?t.user:null,updateUI(t),t?("function"==typeof loadProfile&&loadProfile(t.user),"function"==typeof fetchGoals&&fetchGoals()):nav("market")}document.addEventListener("DOMContentLoaded",(async()=>{document.getElementById("lang_select").value=currentLang;const t=fetchMarketData(),e=sbClient.auth.getSession(),{data:{session:a}}=await e;handleSessionSync(a),sbClient.auth.onAuthStateChange(((t,e)=>{handleSessionSync(e),"SIGNED_IN"===t&&nav("market")})),applyLang(),await t}));let touchStartY=0,isRefreshing=!1;const ptrSpinner=document.getElementById("ptr-spinner");async function handleRefresh(){const t=document.getElementById("ptr-spinner");if(t){t.classList.add("refreshing");try{if(await fetchMarketData(),currentSessionUser){await fetchGoals();"wallet-detail"===localStorage.getItem("last_page")&&currentWalletId&&await fetchPortfolio(currentSessionUser,currentWalletId)}}catch(t){showToast("Sync Error","error")}finally{t.classList.remove("refreshing"),pullDistance=0,isPTRActive=!1,t.style.transform="translateY(-50px) rotate(0deg)"}}}function updateUI(e){const a=document.getElementById("desktop-links"),n=document.getElementById("mobile-nav"),o=document.getElementById("mobile-avatar-container"),r=document.getElementById("mobile-avatar-img"),l=document.getElementById("profile-page-img"),i=document.getElementById("profile-page-name"),s='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>',d='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>';if(e){o.style.display="block";const c=e.user.email.split("@")[0],g=`https://ui-avatars.com/api/?name=${c}&background=F5C518&color=000&rounded=true&bold=true`;r.src=g,l.src=g,i.innerText=c,a.innerHTML=`\n\t\t\t<a onclick="nav('market')" class="nav-item" data-page="market" data-i18n="market">${t("market")}</a>\n\t\t\t<a onclick="nav('portfolio')" class="nav-item" data-page="portfolio" data-i18n="portfolio">${t("portfolio")}</a>\n\t\t\t<a onclick="nav('profile')" class="nav-item" data-page="profile" data-i18n="profile">${t("profile")}</a>`,n.innerHTML=`\n\t\t\t<a onclick="nav('market', this)" data-page="market" class="nav-item">${s}<div data-i18n="market">${t("market")}</div></a>\n\t\t\t<a onclick="nav('portfolio', this)" data-page="portfolio" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12V7a2 2 0 00-2-2H5a2 2 0 00-2 2v11a2 2 0 002 2h14a2 2 0 002-2v-1M21 12a2 2 0 00-2-2h-1a2 2 0 00-2 2v0a2 2 0 002 2h1a2 2 0 002-2z" /></svg><div data-i18n="portfolio">${t("portfolio")}</div></a>\n\t\t\t<a onclick="nav('profile', this)" data-page="profile" class="nav-item">${d}<div data-i18n="profile">${t("profile")}</div></a>`;nav(localStorage.getItem("last_page")||"market")}else{o.style.display="none",a.innerHTML='<a onclick="nav(\'market\')">Market</a><button class="btn-primary" style="width:auto; padding:8px 20px" onclick="nav(\'auth\')" data-i18n="login">Login</button>',n.innerHTML=`<a onclick="nav('market', this)" data-page="market" class="nav-item">${s}<div data-i18n="market">Market</div></a><a onclick="nav('auth', this)" data-page="auth" class="nav-item">${d}<div data-i18n="login">Login</div></a>`,nav("market");[document.getElementById("desktop-sub-badge"),document.getElementById("mobile-sub-badge")].forEach((t=>{t.innerText=""}))}}function nav(t,e){localStorage.setItem("last_page",t),document.querySelectorAll(".section").forEach((t=>t.classList.remove("active-section")));const a=document.getElementById(`page-${t}`);if(a&&a.classList.add("active-section"),document.querySelectorAll("[data-page]").forEach((t=>t.classList.remove("active"))),e)e.classList.add("active");else{document.querySelectorAll(`[data-page="${t}"]`).forEach((t=>t.classList.add("active")))}"portfolio"===t&&(currentSessionUser?fetchGoals():nav("auth"))}function setSubBadge(t){const e=[document.getElementById("desktop-sub-badge"),document.getElementById("mobile-sub-badge")],a="pro"===t?.toLowerCase();e.forEach((t=>{t&&(t.innerText=a?"Pro":"Free",t.className=a?"sub-badge sub-badge-pro":"sub-badge sub-badge-free")}))}document.addEventListener("touchstart",(t=>{0===document.documentElement.scrollTop&&(touchStartY=t.touches[0].pageY)}),{passive:!0}),document.addEventListener("touchmove",(t=>{if(isRefreshing||document.documentElement.scrollTop>0)return;const e=t.touches[0].pageY-touchStartY;e>0&&e<150&&(ptrSpinner.style.display="flex",ptrSpinner.style.top=`${Math.min(e-50,70)}px`,ptrSpinner.style.transform=`translateX(-50%) rotate(${2*e}deg)`)}),{passive:!0}),document.addEventListener("touchend",(async()=>{parseInt(ptrSpinner.style.top)>=60&&!isRefreshing?(isRefreshing=!0,ptrSpinner.style.top="70px",await Promise.all([handleRefresh()]),setTimeout((()=>{ptrSpinner.style.top="-50px",isRefreshing=!1}),500)):ptrSpinner.style.top="-50px"}));const BRAND_CONFIG={antam:{logo:"./logos/antam.jpg",url:"https://www.logammulia.com/id/harga-emas-hari-ini"},"emas kita":{logo:"./logos/emaskita.jpg",url:"https://emaskita.id/Harga_emas"},galeri24:{logo:"./logos/galeri24.jpg",url:"https://galeri24.co.id/harga-emas"},"king halim":{logo:"./logos/kinghalim.jpg",url:"https://www.kinghalim.com/goldbarwithamala"},"lotus archi":{logo:"./logos/lotusarchi.jpg",url:"https://lotusarchi.com/pricing"},sampoerna:{logo:"./logos/sampoerna.jpg",url:"https://sampoernagold.com"},ubs:{logo:"./logos/ubs.jpg",url:"https://ubslifestyle.com/fine-gold/"}},DEFAULT_BRAND={logo:"https://cdn-icons-png.flaticon.com/512/217/217853.png",url:"#"};function getBrandInfo(t){if(!t)return DEFAULT_BRAND;const e=Object.keys(BRAND_CONFIG).find((e=>t.toLowerCase().includes(e)));return BRAND_CONFIG[e]||DEFAULT_BRAND}function getBrandLogo(t){return getBrandInfo(t).logo}function getBrandUrl(t){return getBrandInfo(t).url}let brandWeightMap={};async function fetchMarketData(){const t=new Date;t.setDate(t.getDate()-7);const{data:e}=await sbClient.from("tblpricelog").select("*, tblbrand(brand_name,brand_id)").gt("log_date",t.toISOString().split("T")[0]).order("log_date",{ascending:!1}).order("created_date",{ascending:!1});if(!e)return;new Map;const a=new Set,n=new Map,o=new Map,r=new Set;brandWeightMap={},e.forEach((t=>{const e=t.tblbrand.brand_id,l=t.tblbrand.brand_name,i=t.weight_grams,s=`${l}_${i}`;n.has(s)?o.has(s)||o.set(s,t):(n.set(s,t),a.add(e+"|"+l),r.add(t.weight_grams),brandWeightMap[e]||(brandWeightMap[e]=new Set),brandWeightMap[e].add(i))})),latestPricesMap=n,brandList=Array.from(a).map((t=>{const[e,a]=t.split("|");return{brand_id:e,name:a}})).sort(((t,e)=>t.name.localeCompare(e.name)));document.getElementById("add-brand").innerHTML=brandList.map((t=>`<option value="${t.brand_id}">${t.name}</option>`)).join(""),brandList.length>0&&updateWeightOptions(brandList[0].brand_id);const l=["antam retro","ubs old"],i=Array.from(n.values()).filter((t=>{const e=t.tblbrand?.brand_name?.toLowerCase()||"";return!l.includes(e)})).sort(((t,e)=>{const a=t.tblbrand?.brand_name||"",n=e.tblbrand?.brand_name||"";return a.localeCompare(n)||t.weight_grams-e.weight_grams})),s=document.getElementById("market-summary-container"),d=document.getElementById("summary-cards-list"),c=["antam series","antam retro","ubs old"],g=i.filter((t=>{const e=t.tblbrand?.brand_name?.toLowerCase()||"";return 1===t.weight_grams&&!c.includes(e)})).sort(((t,e)=>t.price-e.price));g.length>0&&(s.style.display="block",d.innerHTML=g.map(((t,e)=>{const a=t.tblbrand?.brand_name||"Unknown",n=0===e,r=`${a}_${t.weight_grams}`,l=o.get(r),i=l?l.price:t.price,s=t.price-i,d=i>0?(s/i*100).toFixed(2):0,c=s>0?"var(--success)":s<0?"var(--danger)":"var(--text-sub)",g=s>0?"↑":s<0?"↓":"•",{time:u,color:m}=formatTime(t);return`\n\t\t\t<div style="flex: 0 0 160px; scroll-snap-align: start; background: var(--card-bg); border: 1px solid ${n?"var(--accent)":"var(--border)"}; padding: 16px; border-radius: 16px; position: relative;">\n\t\t\t\t${n?'<div style="position:absolute; top:0; right:0; background:var(--accent); color:#000; font-size:8px; font-weight:900; padding:2px 6px; border-bottom-left-radius:8px;">BEST VALUE</div>':""}\n\t\t\t\t<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">\n\t\t\t\t\t<a href="${getBrandUrl(a)}" target="_blank" style="text-decoration:none; display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">\n\t\t\t\t\t\t<img src="${getBrandLogo(a)}" style="width:20px; height:20px; border-radius:50%; background:#fff;">\n\t\t\t\t\t\t<span style="font-size:12px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">\n\t\t\t\t\t\t${a}<br>\n\t\t\t\t\t\t<text style="font-size:8px; opacity:0.5">Last Update : ${u}</text>\n\t\t\t\t\t</a>\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="price-font" style="font-size:14px; font-weight:800; color:${n?"var(--accent)":"var(--text-main)"}">\n\t\t\t\t\tRp ${t.price.toLocaleString("id-ID")}\n\t\t\t\t</div>\n\t\t\t\t<div style="font-size:10px; font-weight:700; color:${c}; margin-top:4px;">\n\t\t\t\t\t${g} Rp ${Math.abs(s).toLocaleString("id-ID")} (${d}%)\n\t\t\t\t</div>\n\t\t\t</div>`})).join("")),document.getElementById("desktop-tbody").innerHTML=i.map((t=>{const{time:e,color:a}=formatTime(t);return`<tr>\n\t\t\t<td><span style="color:var(--accent); font-weight:700">${t.tblbrand?.brand_name}</span></td>\n\t\t\t<td>${t.weight_grams}g</td>\n\t\t\t<td style="text-align:right" class="price-font">Rp ${t.price.toLocaleString("id-ID")}</td>\n\t\t\t<td style="text-align:right; opacity:0.6">Rp ${t.buyback_price.toLocaleString("id-ID")}</td>\n\t\t\t<td style="text-align:right; font-size:12px; color:${a}">${e}</td>\n\t\t</tr>`})).join(""),document.getElementById("mobile-list").innerHTML=i.map((t=>{const{time:e,isToday:a}=formatTime(t),n=a?'<span class="pill-update">Today</span>':"",o=getBrandLogo(t.tblbrand?.brand_name||"");return`\n\t\t<div class="crypto-row" onclick="window.open('${getBrandUrl(t.tblbrand?.brand_name)}', '_blank')" style="cursor:pointer;">\n\t\t\t<div class="row-left">\n\t\t\t\t<img src="${o}" class="brand-logo-img" alt="logo" onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/217/217853.png';">\n\t\t\t\t<div>\n\t\t\t\t\t<div class="coin-name">${t.tblbrand?.brand_name} <span style="font-size:12px; opacity:0.5">· ${t.weight_grams}g</span></div>\n\t\t\t\t\t<div class="coin-weight">${e} ${n}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="row-right">\n\t\t\t\t<div class="coin-price price-font">Rp ${t.price.toLocaleString("id-ID")}</div>\n\t\t\t\t<div class="coin-sub">Buyback: Rp ${t.buyback_price.toLocaleString("id-ID")}</div>\n\t\t\t</div>\n\t\t</div>`})).join("")}function updateWeightOptions(t){const e=document.getElementById("add-weight"),a=Array.from(brandWeightMap[t]||[]).sort(((t,e)=>t-e));a.length>0?e.innerHTML=a.map((t=>`<option value="${t}">${t} Gram</option>`)).join(""):e.innerHTML='<option value="">No weights available</option>'}async function fetchGoals(){if(!currentSessionUser||!currentSessionUser.id)return;const t=document.getElementById("goal-buyback-toggle").checked,{data:e}=await sbClient.from("tblwallet").select("*").eq("user_id",currentSessionUser.id).order("created_date",{ascending:!0}),{data:a}=await sbClient.from("tblinventory").select("weight_grams, purchase_price, wallet_id, tblbrand(brand_name)").eq("user_id",currentSessionUser.id),n=document.getElementById("goal-list-container");let o=0,r=0,l=0;if(!e||0===e.length)return n.innerHTML='<div style="text-align:center; padding:40px; color:var(--text-sub);" data-i18n="no_goals">Portfolio is empty.</div>',void updateGrandTotalDisplay(0,0,0);n.innerHTML=e.map((e=>{const n=a?a.filter((t=>t.wallet_id===e.wallet_id)):[],i=n.reduce(((e,a)=>{const n=latestPricesMap.get(`${a.tblbrand.brand_name}_${a.weight_grams}`),o=t?n?.buyback_price||0:n?.price||0;return r+=a.weight_grams,l+=a.purchase_price||0,e+o}),0);o+=i;const s=Math.min(i/e.goal_amount*100,100).toFixed(1),d=isAmountHidden?"••%":`${s}%`,c=isAmountHidden?"••••••••":`Rp ${i.toLocaleString("id-ID")}`,g=isAmountHidden?"••••••••":`Rp ${e.goal_amount.toLocaleString("id-ID")}`,u=isAmountHidden?"0":s;return`\n\t\t\t<div class="goal-card" onclick="openWalletDetail('${e.wallet_id}', '${e.wallet_name}', ${n.length})">\n\t\t\t\t<div style="display:flex; justify-content:space-between; align-items:center;">\n\t\t\t\t\t<span style="font-weight:700; font-size:16px;">${e.wallet_name}</span>\n\t\t\t\t\t<span style="color:var(--accent); font-weight:800; font-size:12px;">${d}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="progress-container">\n\t\t\t\t\t<div class="progress-bar" style="width: ${u}%"></div>\n\t\t\t\t</div>\n\t\t\t\t<div style="display:flex; justify-content:space-between; font-size:12px;">\n\t\t\t\t\t<span class="price-font">${c}</span>\n\t\t\t\t\t<span style="color:var(--text-sub)">Target: ${g}</span>\n\t\t\t\t</div>\n\t\t\t</div>`})).join(""),updateGrandTotalDisplay(o,r,l)}function updateGrandTotalDisplay(t,e,a){const n=document.getElementById("goal-grand-total"),o=document.getElementById("goal-grand-grams"),r=document.getElementById("goal-grand-pl"),l=t-a,i=a>0?(l/a*100).toFixed(2):0;if(isAmountHidden)n.innerText="Rp ••••••••",o.innerText="••• Grams",r.innerText="••••••••",r.style.color="inherit";else{n.innerText=`Rp ${t.toLocaleString("id-ID")}`,o.innerText=`${e.toFixed(2)} Grams`;const a=l>=0?"#268851":"var(--danger)";r.style.color=a,r.innerText=`${l>=0?"+":""}Rp ${l.toLocaleString("id-ID")} (${i}%)`}}function openWalletDetail(t,e,a){currentWalletId=t,currentWalletName=e,localStorage.setItem("current_wallet_id",t),localStorage.setItem("current_wallet_name",e);const n=document.getElementById("modal-delete-container");n.innerHTML=0===a?`\n            <span style="color:#999; font-size:12px;" onclick="deleteGoal('${t}')">\n                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18m-2 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>\n            </span>`:"",document.getElementById("wallet-name-display").innerText=e,nav("wallet-detail"),fetchPortfolio(currentSessionUser,t)}function toggleGoalModal(t,e="",a=0){const n=document.getElementById("goal-modal"),o=document.getElementById("goal-modal-submit-btn");n.style.display="flex"===n.style.display?"none":"flex","update"===t?(document.getElementById("goal-name").value=e,document.getElementById("goal-target").value=a,formatRupiahInput(document.getElementById("goal-target")),document.getElementById("modal-delete-container").style.display="",n.querySelector("h3").innerText="Edit Portfolio",o.innerText="Update",o.onclick=function(){updateGoal()}):(document.getElementById("modal-delete-container").style.display="none",document.getElementById("goal-name").value="",document.getElementById("goal-target").value="",n.querySelector("h3").innerText="Add New Portfolio",o.innerText="Save",o.onclick=function(){saveGoal()})}async function saveGoal(){if(!currentSessionUser)return showToast("Please login","failed");const e=document.getElementById("goal-name").value,a=document.getElementById("goal-target").value.replace(/\./g,"");if(!e||!a)return showToast(t("fill_all"),"failed");const{error:n}=await sbClient.from("tblwallet").insert({user_id:currentSessionUser.id,wallet_name:e,goal_amount:parseFloat(a)});n?showToast(n.message,"failed"):(showToast("en"===currentLang?"Portfolio successfully added":"Portofolio berhasil ditambahkan"),toggleGoalModal(),fetchGoals())}async function deleteGoal(t){deleteTargetId=t;const e=document.getElementById("confirm-modal");document.getElementById("confirm-msg").innerText="en"===currentLang?"Are you sure want to delete this ?":"Apakah kamu yakin akan menghapus ini ?",e.style.display="flex",document.getElementById("confirm-exec-btn").onclick=async()=>{const{error:t}=await sbClient.from("tblwallet").delete().eq("wallet_id",deleteTargetId);t?showToast("Error :"+t.message,"failed"):(showToast("en"===currentLang?"Portfolio deleted":"Portfolio dihapus"),toggleGoalModal(),closeConfirm(),nav("portfolio"),fetchGoals())}}function openEditGoalModal(){toggleGoalModal("update",currentWalletName,currentGoalTarget)}async function updateGoal(){const t=document.getElementById("goal-name").value,e=document.getElementById("goal-target").value.replace(/\./g,"");if(!t||!e)return showToast("Fields cannot be empty","error");const{error:a}=await sbClient.from("tblwallet").update({wallet_name:t,goal_amount:parseFloat(e)}).eq("wallet_id",currentWalletId);a?showToast(a.message,"error"):(showToast("Goal updated successfully!"),currentWalletName=t,currentGoalTarget=parseFloat(e),toggleGoalModal(),document.getElementById("wallet-name-display").innerText=t,fetchPortfolio(currentSessionUser,currentWalletId))}document.getElementById("goal-buyback-toggle").addEventListener("change",(t=>{document.getElementById("buyback-toggle").checked=t.target.checked})),document.getElementById("buyback-toggle").addEventListener("change",(t=>{document.getElementById("goal-buyback-toggle").checked=t.target.checked}));let isAmountHidden="true"===localStorage.getItem("hide_amount"),rawNetWorth="Rp 0",rawGrams="0.00 Grams",rawPL="Rp 0 (0%)",rawColor="var(--text-sub)",rawColorSum="var(--text-sub)",rawBackground="rgba(255, 255, 255, 0.05)",rawGrandTotal=0,rawGrandGrams=0,rawGrandPL=0,rawInvGram=0,rawInvBuy=0,rawInvPrice=0,rawInvDiff=0,currentSessionUser=null,currentGoalTarget=0,rawProgress="0%",rawTargetLabel="Target: Rp 0";async function fetchPortfolio(e,a=null){if(!e)return;const n=a||currentWalletId;if(!n)return;currentWalletId=n;let o=0,r=0,l=0;rawNetWorth="Rp 0",rawGrams="0.00 Grams",rawPL="Rp 0 (0%)",rawProgress="0%",rawTargetLabel="Target: Rp 0";const i=document.getElementById("portfolio-list"),s=document.getElementById("portfolio-desktop-tbody"),d=document.getElementById("buyback-toggle").checked,{data:c}=await sbClient.from("tblwallet").select("*").eq("wallet_id",n).single();c&&(currentGoalTarget=c.goal_amount,currentWalletName=c.wallet_name,document.getElementById("wallet-name-display").innerText=c.wallet_name,rawTargetLabel=`Target: Rp ${c.goal_amount.toLocaleString("id-ID")}`);const g=document.getElementById("portfolio-sort").value;let u=!1,m="created_date";g.startsWith("weight")&&(m="weight_grams"),g.startsWith("brand")&&(m="tblbrand(brand_name)"),g.endsWith("asc")&&(u=!0);const{data:p,error:h}=await sbClient.from("tblinventory").select("*, tblbrand(brand_name)").eq("user_id",e.id).eq("wallet_id",n).order(m,{ascending:u});if(h||!p||0===p.length)return i.innerHTML=`<div style="text-align:center; padding:40px; color:var(--text-sub);">${t("vaultisempty")}</div>`,s&&(s.innerHTML=""),updatePortfolioDisplay(),void updateProgressBar(0);let f="",y="";p.forEach((t=>{const e=t.tblbrand?.brand_name||"Unknown",a=t.weight_grams||0,n=t.purchase_price||0,i=t.purchase_date?new Date(t.purchase_date).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}):"No Date",s=latestPricesMap.get(`${e}_${a}`),c=d?s?.buyback_price||0:s?.price||0;o+=c,r+=n,l+=a;const g=c-n,u=g>=0?"var(--success)":"var(--danger)";rawInvGram=a,rawInvBuy=n,rawInvPrice=c,rawInvDiff=g;const m='<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18m-2 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>';f+=`\n\t\t\t<tr>\n\t\t\t\t<td><img src="${getBrandLogo(e)}" style="width:24px; vertical-align:middle; margin-right:10px;"> <b>${e}</b></td>\n\t\t\t\t<td style="color:var(--text-sub)">${i}</td>\n\t\t\t\t<td style="text-align:right">${isAmountHidden?"•":a}g</td>\n\t\t\t\t<td style="text-align:right">Rp ${isAmountHidden?"••••••••":n.toLocaleString("id-ID")}</td>\n\t\t\t\t<td style="text-align:right" class="price-font">Rp ${isAmountHidden?"••••••••":c.toLocaleString("id-ID")}</td>\n\t\t\t\t<td style="text-align:right; color:${isAmountHidden?"--var(text-sub)":u}; font-weight:700">${isAmountHidden?"Rp":g>=0?"+Rp":"Rp"} ${isAmountHidden?"••••••••":g.toLocaleString("id-ID")}</td>\n\t\t\t\t<td style="text-align:right"><button onclick="deleteInventory('${t.inventory_id}')" style="background:none; border:none; color:var(--text-sub); cursor:pointer; padding:5px;">${m}</button></td>\n\t\t\t</tr>`,y+=`\n\t\t\t<div class="swipe-container">\n\t\t\t\t<div class="swipe-action-bg" onclick="deleteInventory('${t.inventory_id}')">\n\t\t\t\t\t${m}\n\t\t\t\t</div>\n\t\t\t\t<div class="crypto-row crypto-row-swipeable" \n\t\t\t\t\tontouchstart="handleTouchStart(event)" \n\t\t\t\t\tontouchmove="handleTouchMove(event)" \n\t\t\t\t\tontouchend="handleTouchEnd(event)">\n\t\t\t\t\t<div class="row-left">\n\t\t\t\t\t\t<img src="${getBrandLogo(e)}" class="brand-logo-img">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<div class="coin-name">${e} <span style="font-size:12px; opacity:.5" id="invent-weight">${isAmountHidden?"•":a}g</span></div>\n\t\t\t\t\t\t\t<div class="coin-weight"><span data-i18n="buy">Buy</span>: <text id="invent-buy">Rp ${isAmountHidden?"••••••••":n.toLocaleString("id-ID")}</text></div>\n\t\t\t\t\t\t\t<div class="coin-weight">${i}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="row-right">\n\t\t\t\t\t\t<div class="coin-price price-font">Rp ${isAmountHidden?"••••••••":c.toLocaleString("id-ID")}</div>\n\t\t\t\t\t\t<div class="coin-sub" style="color:${isAmountHidden?"--var(text-sub)":u};font-weight:700" id="invent-diff">${isAmountHidden?"Rp":g>=0?"+Rp":"Rp"} ${isAmountHidden?"••••••••":g.toLocaleString("id-ID")}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>`})),s.innerHTML=f,i.innerHTML=y;const b=o-r,v=r>0?(b/r*100).toFixed(2):0,w=currentGoalTarget>0?o/currentGoalTarget*100:0;rawNetWorth=`Rp ${o.toLocaleString("id-ID")}`,rawGrams=`${l.toFixed(2)} Grams`,rawPL=`${b>=0?"+":""}Rp ${b.toLocaleString("id-ID")} (${v}%)`,rawProgress=`${Math.min(w,100).toFixed(1)}%`,rawColor=b>=0?"var(--success)":"var(--danger)",rawColorSum=b>=0?"rgb(38, 136, 81)":"var(--danger)",rawBackground=b>=0?"rgba(39, 201, 110, 0.1)":"rgba(255, 77, 77, 0.1)",document.getElementById("pf-grams").innerText=`${l.toFixed(2)} Grams`,updatePortfolioDisplay(),updateProgressBar(w)}function toggleAmountVisibility(){isAmountHidden=!isAmountHidden,localStorage.setItem("hide_amount",isAmountHidden),updatePortfolioDisplay(),"portfolio"===localStorage.getItem("last_page")&&(fetchGoals(),currentSessionUser&&fetchPortfolio(currentSessionUser))}function updatePortfolioDisplay(){const t=document.getElementById("pf-total"),e=document.getElementById("pf-grams"),a=document.getElementById("pf-pl"),n=document.getElementById("goal-grand-total"),o=document.getElementById("goal-grand-grams"),r=document.getElementById("goal-grand-pl"),l=document.getElementById("progress-percent"),i=document.getElementById("progress-target"),s=document.getElementById("progress-bar-fill"),d="••••••••";isAmountHidden?(t&&(t.innerText=d),e&&(e.innerText="••• Grams"),a&&(a.innerText=d),a&&(a.style.color="var(--text-sub)"),a&&(a.style.background="rgba(255, 255, 255, 0.05)"),n&&(n.innerText=d),o&&(o.innerText="••• Grams"),r&&(r.innerText=d),l&&(l.innerText="••%"),i&&(i.innerText="Target: ••••••"),s&&(s.style.width="0%"),document.querySelectorAll(".eye-icon-all, #eye-icon").forEach((t=>{t.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>'}))):(t&&(t.innerText=rawNetWorth),e&&(e.innerText=rawGrams),a&&(a.innerText=rawPL),a&&(a.style.color=rawColorSum),a&&(a.style.background=rawBackground),n&&(n.innerText=rawGrandTotal),o&&(o.innerText=rawGrandGrams),r&&(r.innerText=rawGrandPL),l&&(l.innerText=rawProgress),i&&(i.innerText=rawTargetLabel),document.querySelectorAll(".eye-icon-all, #eye-icon").forEach((t=>{t.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>'})))}function updateProgressBar(t){const e=document.getElementById("progress-bar-fill");e&&(isAmountHidden||(e.style.width=`${Math.min(t,100)}%`))}function toggleAddModal(){const t=document.getElementById("add-modal");t.style.display="flex"===t.style.display?"none":"flex","flex"===t.style.display&&(document.getElementById("add-date").valueAsDate=new Date)}async function saveInventory(){if(!currentSessionUser)return showToast("en"===currentLang?"Please login first":"Mohon login terlebih dahulu","failed");const t=document.getElementById("add-brand").value,e=parseFloat(document.getElementById("add-weight").value),a=parseFloat(document.getElementById("add-price").value.replace(/\./g,"")),n=document.getElementById("add-date").value;if(!t||!e||!a)return showToast("en"===currentLang?"Please fill all fields":"Mohon isi semua kolom","failed");const{error:o}=await sbClient.from("tblinventory").insert({user_id:currentSessionUser.id,brand_id:t,weight_grams:e,purchase_price:a,purchase_date:n,wallet_id:currentWalletId});o?showToast("Error: "+o.message,"failed"):(showToast("en"===currentLang?"Added successfully":"Berhasil menambahkan"),toggleAddModal(),document.getElementById("add-price").value="",fetchPortfolio(currentSessionUser))}let deleteTargetId=null;async function deleteInventory(t){deleteTargetId=t;const e=document.getElementById("confirm-modal");document.getElementById("confirm-msg").innerText="en"===currentLang?"Are you sure want to delete this ?":"Apakah kamu yakin akan menghapus ini ?",e.style.display="flex",document.getElementById("confirm-exec-btn").onclick=async()=>{const{error:t}=await sbClient.from("tblinventory").delete().eq("inventory_id",deleteTargetId);t?showToast("Error :"+t.message,"failed"):(showToast("en"===currentLang?"Item deleted":"Aset dihapus"),closeConfirm(),fetchPortfolio(currentSessionUser))}}function closeConfirm(){document.getElementById("confirm-modal").style.display="none",deleteTargetId=null}let startX=0,currentTarget=null;function handleTouchStart(t){document.querySelectorAll(".crypto-row-swipeable").forEach((e=>{e!==t.currentTarget&&e.classList.remove("swiped")})),startX=t.touches[0].clientX,currentTarget=t.currentTarget}function handleTouchMove(t){let e=t.touches[0].clientX,a=startX-e;a>30?currentTarget.classList.add("swiped"):a<-30&&currentTarget.classList.remove("swiped")}function handleTouchEnd(t){currentTarget=null}function toggleAuth(){const t=document.getElementById("login-box"),e=document.getElementById("register-box");"none"===t.style.display?(t.style.display="block",e.style.display="none"):(t.style.display="none",e.style.display="block")}async function handleLogin(){const t=document.getElementById("l-email").value,e=document.getElementById("l-password").value,{error:a}=await sbClient.auth.signInWithPassword({email:t,password:e});a?showToast("Error: "+a.message,"failed"):nav("market")}async function handleRegister(){const t=document.getElementById("r-name").value,e=document.getElementById("r-email").value,a=document.getElementById("r-password").value,{error:n}=await sbClient.auth.signUp({email:e,password:a,options:{data:{full_name:t}}});n?showToast("Error: "+n.message,"failed"):(showToast("en"===currentLang?"Registration Successful. Your account has been created":"Registrasi berhasil. Akunmu telah terbuat"),toggleAuth())}async function handleLogout(){await sbClient.auth.signOut(),nav("market")}async function loadProfile(t){document.getElementById("prof-email").value=t.email;const{data:e}=await sbClient.from("tbluser").select("full_name, user_type, tbllang(lang_code,lang_id)").eq("id",t.id).single();e&&(document.getElementById("prof-name").value=e.full_name||"",document.getElementById("profile-page-name").innerText=e.full_name||t.email.split("@")[0],document.getElementById("lang_select").value=e.tbllang.lang_code.toLowerCase(),setSubBadge(e.user_type),toggleLang(e.tbllang.lang_code.toLowerCase()),applyLang())}async function updateName(){const t=document.getElementById("prof-name").value,e=document.getElementById("lang_select").value,{data:{user:a}}=await sbClient.auth.getUser(),{data:n}=await sbClient.from("tbllang").select("lang_id").eq("lang_code",e.toUpperCase());let o="";n.forEach((t=>{const e=t.lang_id;o+=`${e}`})),await sbClient.from("tbluser").update({full_name:t,lang_id:o}).eq("id",a.id),showToast("en"===currentLang?"Your profile has been updated":"Profil berhasil diperbarui"),loadProfile(a),location.reload()}async function updatePassword(){const t=document.getElementById("prof-pass").value;t&&(await sbClient.auth.updateUser({password:t}),showToast("en"===currentLang?"Your password has been changed":"Password berhasil diganti"))}function formatTime(t){const e=new Date(t.created_date||t.log_date),a=e.toDateString()===(new Date).toDateString(),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()],o=`${e.getDate()} ${n} ${e.getHours()}:${e.getMinutes().toString().padStart(2,"0")}`;return{time:a?`${e.getHours()}:${e.getMinutes().toString().padStart(2,"0")}`:o,color:a?"var(--success)":"var(--danger)",isToday:a}}function showToast(t,e="success"){const a=document.getElementById("toast-container"),n=document.createElement("div");n.className=`toast toast-${e}`,n.innerHTML=`<span>${t}</span>`,a.appendChild(n),setTimeout((()=>n.remove()),3e3)}function formatRupiahInput(t){let e=t.value.replace(/[^0-9]/g,"");t.value=e?parseInt(e,10).toLocaleString("id-ID"):""}let currentLang=localStorage.getItem("lang")||"en";function toggleLang(t){currentLang=t,localStorage.setItem("lang",currentLang)}function t(t){return i18n[currentLang][t]||t}function applyLang(){document.querySelectorAll("[data-i18n]").forEach((e=>{const a=e.getAttribute("data-i18n");e.innerText=t(a)}))}const i18n={en:{market:"Market",portfolio:"Portfolio",wallet:"Wallet",profile:"Profile",today_market:"Today's Market",best_value:"BEST VALUE",net_worth:"Total Net Worth",buyback:"Buyback",sign_out:"Sign Out",save_changes:"Save Changes",brand:"Brand",weight:"Weight",price:"Price",updated:"Updated",cost:"Buy Price",market_value:"Market Value",pl:"Profit/Loss",purchase_date:"Purchase Date",date_newest:"Date (Newest)",date_oldest:"Date (Oldest)",weight_high:"Weight (High)",weight_low:"Weight (Low)",lang_pref:"Language Preference",change_pass:"Change Password",change_pass_btn:"Update Password",email_address:"Email Address",full_name:"Full Name",update_profile_btn:"Save Changes",english:"English",indonesian:"Indonesian",logout:"Logout",add_item:"Add New Item",save:"Save",cancel:"Cancel",delete:"Delete",delete_portfolio:"Confirm Delete Portfolio",buy:"Buy",vaultisempty:"Vault is empty",setnewgoal:"Add New Portfolio",add_new_goal:"Add New Portfolio",goal_name:"Portfolio Name",goal_target:"Goal Target"},id:{market:"Pasar",portfolio:"Portofolio",wallet:"Aset",profile:"Profil",today_market:"Harga Hari Ini",best_value:"Harga Terbaik",net_worth:"Total Aset Anda",buyback:"Harga Jual Kembali",sign_out:"Keluar",save_changes:"Simpan Perubahan",brand:"Merk",weight:"Berat",price:"Harga",updated:"Data Update",cost:"Harga Pembelian",market_value:"Harga Pasar",pl:"Untung/Rugi",purchase_date:"Tanggal Pembelian",date_newest:"Tanggal (Terbaru)",date_oldest:"Tanggal (Terlama)",weight_high:"Berat (Tertinggi)",weight_low:"Berat (Terendah)",lang_pref:"Preferensi Bahasa",change_pass:"Ubah Kata Sandi",change_pass_btn:"Atur Kata Sandi",email_address:"Alamat Email",full_name:"Nama Lengkap",update_profile_btn:"Simpan Perubahan",english:"Bahasa Inggris",indonesian:"Bahasa Indonesia",logout:"Keluar",add_item:"Tambah Aset",save:"Simpan",cancel:"Batal",delete:"Hapus",delete_portfolio:"Konfirmasi Hapus Aset",buy:"Beli",vaultisempty:"Tidak ada aset",setnewgoal:"Tambah Portofolio",add_new_goal:"Tambah Portofolio Baru",goal_name:"Portofolio Name",goal_target:"Target Goal"}};