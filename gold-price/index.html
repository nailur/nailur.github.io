<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gold Pulse | Portfolio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #05070a;
            --card-bg: rgba(22, 27, 34, 0.4);
            --accent: #fbbf24;
            --success: #22c55e;
            --border: rgba(255, 255, 255, 0.08);
            --text-dim: #8b949e;
        }
        
        body {
            margin: 0; background: var(--bg); color: #f0f6fc;
            font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased;
        }

        header {
            position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(12px); background: rgba(5, 7, 10, 0.8);
            padding: 14px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        .container { padding: 16px; max-width: 950px; margin: 0 auto; }

        /* Summary Bento Grid */
        #summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .card { 
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 18px; padding: 16px; transition: transform 0.2s;
        }
        .best-deal { grid-column: span 2; border-color: rgba(251, 191, 36, 0.3); }

        /* Table Styling */
        .table-wrap { 
            background: var(--card-bg); border-radius: 16px; 
            border: 1px solid var(--border); overflow-x: auto; 
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 400px; }
        th { text-align: left; padding: 12px; color: var(--text-dim); font-size: 10px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }

        /* Input Styling */
        select, input {
            width: 100%; padding: 12px; border-radius: 12px; margin-bottom: 12px;
            background: #161b22; color: #fff; border: 1px solid var(--border);
            font-family: inherit; box-sizing: border-box;
        }

        .status-pill {
            font-size: 9px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05);
        }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            .price-val { font-size: 0.9rem; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>

<header>
    <div onclick="toggleMenu()" style="cursor:pointer">â˜°</div>
    <span style="font-weight:800; letter-spacing:-0.5px">GOLD PULSE</span>
    <div id="sync-dot" style="width:8px; height:8px; border-radius:50%; background:var(--success)"></div>
</header>

<div class="container">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px">
        <h3 style="margin:0; font-size:14px">Market Overview</h3>
        <span id="update-timer" style="font-size:10px; color:var(--text-dim)">Checking...</span>
    </div>

    <select id="filter" onchange="renderFull()"></select>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Brand</th>
                    <th>Gram</th>
                    <th>Price</th>
                    <th>Buyback</th>
                    <th>Update</th>
                </tr>
            </thead>
            <tbody id="fullTable">
                <tr><td colspan="5" style="text-align:center; padding:40px">Loading live market data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const API = "https://nailur.vercel.app/api/harga-emas";
    let rawData = [];

    async function load() {
        const dot = document.getElementById('sync-dot');
        dot.style.opacity = '0.5';
        
        try {
            const r = await fetch(API);
            const j = await r.json();
            rawData = j.data || [];
            
            buildFilter();
            renderFull();
            
            document.getElementById('update-timer').textContent = `Live: ${new Date().toLocaleTimeString()}`;
            dot.style.opacity = '1';
        } catch(e) {
            console.error("Fetch error", e);
            document.getElementById('fullTable').innerHTML = '<tr><td colspan="5" style="text-align:center; color:red">Connection failed. Retrying...</td></tr>';
        }
    }

    const cleanNum = n => n ? Number(String(n).replace(/[^\d]/g,"")) : 0;

    function buildFilter() {
        const sel = document.getElementById("filter");
        if(sel.options.length > 0) return;
        const cats = [...new Set(rawData.map(r => r.category))].sort();
        sel.innerHTML = '<option value="ALL">All Brands</option>' + 
            cats.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function renderFull() {
		const f = document.getElementById("filter").value;
		const container = document.getElementById("fullTable");
		
		let rows = f === "ALL" ? [...rawData] : rawData.filter(r => r.category === f);
		
		rows.sort((a, b) => {
			const catA = String(a.category).toUpperCase();
			const catB = String(b.category).toUpperCase();
			
			if (catA < catB) return -1;
			if (catA > catB) return 1;
			
			return cleanNum(a.gram) - cleanNum(b.gram);
		});

		container.innerHTML = rows.map(r => `
			<tr>
				<td><span style="font-weight:700">${r.category}</span></td>
				<td>${r.gram}g</td>
				<td style="text-align:right; font-weight:800">Rp ${cleanNum(r.category == 'ANTAM' ? Math.floor(r.jual / 1.0025) : r.jual).toLocaleString('id-ID')}</td>
				<td style="text-align:right; color:var(--text-dim)">Rp ${cleanNum(r.buyback).toLocaleString('id-ID')}</td>
				<td style="text-align:center"><span class="status-pill">${formatUpdateDate(r.last_update)}</span></td>
			</tr>
		`).join('');
	}

    function formatUpdateDate(dateStr) {
		if (!dateStr || dateStr === "null" || dateStr.trim() === "") return "-";

		const d = new Date(dateStr.replace(/-/g, "/"));
		if (isNaN(d.getTime())) return dateStr;

		const day = String(d.getDate()).padStart(2, '0');
		const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
		const month = months[d.getMonth()];
		
		const hasTimeInSource = dateStr.includes(":");

		if (!hasTimeInSource) {
			return `${day}-${month}`; 
		} else {
			const hh = String(d.getHours()).padStart(2, '0');
			const mm = String(d.getMinutes()).padStart(2, '0');
			return `${day}-${month} ${hh}:${mm}`;
		}
	}

    load();
    setInterval(load, 300000);
</script>
</body>
</html>