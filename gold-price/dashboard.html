<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gold Pulse | Senior Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #05070a;
            --card: #161b22;
            --border: #30363d;
            --accent: #fbbf24; /* Gold */
            --text: #c9d1d9;
            --text-dim: #8b949e;
            --danger: #f85149;
            --success: #2ea043;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Auth Screen */
        #auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .auth-box { background: var(--card); padding: 2rem; border-radius: 12px; border: 1px solid var(--border); width: 100%; max-width: 350px; }
        .auth-box h2 { color: var(--accent); margin-top: 0; text-align: center; }
        
        /* Dashboard */
        #dashboard-container { display: none; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        
        /* Forms */
        input { width: 100%; padding: 12px; margin: 8px 0; background: #0d1117; border: 1px solid var(--border); color: white; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 15px; background: var(--accent); border: none; font-weight: 700; color: black; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; width: auto; padding: 8px 16px; margin: 0; }

        /* Table */
        .table-wrap { overflow-x: auto; background: var(--card); border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; padding: 12px 16px; color: var(--text-dim); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .price-cell { font-family: 'Monaco', monospace; font-weight: 600; color: white; text-align: right; }
        .brand-badge { background: rgba(251, 191, 36, 0.1); color: var(--accent); padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        
        /* Utils */
        .hidden { display: none !important; }
        .error-msg { color: var(--danger); font-size: 12px; text-align: center; margin-top: 10px; display: none; }
        .link { color: var(--accent); cursor: pointer; font-size: 12px; text-align: center; display: block; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-box" id="login-box">
            <h2>GOLD PULSE</h2>
            <p style="text-align:center; font-size:13px; color:var(--text-dim); margin-bottom:20px">Member Login</p>
            <input type="email" id="l-email" placeholder="Email">
            <input type="password" id="l-password" placeholder="Password">
            <button onclick="handleLogin()">Sign In</button>
            <p id="l-error" class="error-msg"></p>
            <span class="link" onclick="toggleAuth()">Need an account? Register</span>
        </div>

        <div class="auth-box hidden" id="register-box">
            <h2>JOIN PULSE</h2>
            <p style="text-align:center; font-size:13px; color:var(--text-dim); margin-bottom:20px">Create Portfolio</p>
            <input type="email" id="r-email" placeholder="Email">
            <input type="password" id="r-password" placeholder="Password">
            <button onclick="handleRegister()">Register</button>
            <p id="r-error" class="error-msg"></p>
            <span class="link" onclick="toggleAuth()">Have an account? Login</span>
        </div>
    </div>

    <div id="dashboard-container">
        <header>
            <div>
                <h1 style="margin:0; font-size:20px">My Dashboard</h1>
                <span style="font-size:12px; color:var(--text-dim)" id="user-display">Welcome</span>
            </div>
            <button class="btn-danger" onclick="handleLogout()">Logout</button>
        </header>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h3 style="margin:0">Today's Market Prices</h3>
            <span style="font-size:12px; background:#238636; padding:4px 8px; border-radius:12px; color:white">Live DB Connection</span>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Weight</th>
                        <th style="text-align:right">Selling Price</th>
                        <th style="text-align:right">Buyback</th>
                        <th style="text-align:center">Date</th>
                    </tr>
                </thead>
                <tbody id="price-table">
                    <tr><td colspan="5" style="text-align:center; padding:20px">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<script>
    const SUPABASE_URL = "https://iwsacljessokrqhfmdbv.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3c2FjbGplc3Nva3JxaGZtZGJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxODcyNTMsImV4cCI6MjA4Mzc2MzI1M30.jQ_8KR76Xbbn1Heest75p3I78J6oiSt9V-H31cWWLOo";
    
    const supabase = supa.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Check session on load
    window.onload = async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) showDashboard(session.user);
    };

    async function handleLogin() {
        const email = document.getElementById('l-email').value;
        const password = document.getElementById('l-password').value;
        const errEl = document.getElementById('l-error');
        
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        
        if (error) {
            errEl.textContent = error.message;
            errEl.style.display = 'block';
        } else {
            showDashboard(data.user);
        }
    }

    async function handleRegister() {
        const email = document.getElementById('r-email').value;
        const password = document.getElementById('r-password').value;
        const errEl = document.getElementById('r-error');

        const { data, error } = await supabase.auth.signUp({ email, password });

        if (error) {
            errEl.textContent = error.message;
            errEl.style.display = 'block';
        } else {
            alert("Registration successful! Please check your email to verify (or login if auto-confirm is on).");
            toggleAuth();
        }
    }

    async function handleLogout() {
        await supabase.auth.signOut();
        location.reload();
    }

    function showDashboard(user) {
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('dashboard-container').style.display = 'block';
        document.getElementById('user-display').textContent = `User: ${user.email}`;
        fetchTodayPrices();
    }

    async function fetchTodayPrices() {
        // Get Today's Date in YYYY-MM-DD format
        const today = new Date().toISOString().split('T')[0];

        const { data, error } = await supabase
            .from('tblpricelog')
            .select(`
                price, 
                buyback_price, 
                weight_grams, 
                log_date,
                tblbrand ( brand_name, brand_code ) 
            `)
            .eq('log_date', today)
            .order('price', { ascending: true });

        const tbody = document.getElementById('price-table');

        if (error) {
            console.error(error);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:var(--danger)">Failed to load data: ${error.message}</td></tr>`;
            return;
        }

        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No data found for today (${today}). Run the API scraper first.</td></tr>`;
            return;
        }

        tbody.innerHTML = data.map(item => `
            <tr>
                <td>
                    <span class="brand-badge">${item.tblbrand?.brand_name || 'Unknown'}</span>
                </td>
                <td>${item.weight_grams}g</td>
                <td class="price-cell">Rp ${item.price.toLocaleString('id-ID')}</td>
                <td class="price-cell" style="color:var(--text-dim)">Rp ${item.buyback_price.toLocaleString('id-ID')}</td>
                <td style="text-align:center; color:var(--text-dim)">${item.log_date}</td>
            </tr>
        `).join('');
    }

    function toggleAuth() {
        document.getElementById('login-box').classList.toggle('hidden');
        document.getElementById('register-box').classList.toggle('hidden');
    }
</script>
</body>
</html>