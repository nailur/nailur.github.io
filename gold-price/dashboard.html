<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>NTGold | Today Market Price | Manage Portofolio</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		:root {
			--bg: #05070a;
			--card: #161b22;
			--border: #30363d;
			--accent: #fbbf24;
			--text: #c9d1d9;
			--dim: #8b949e;
			--danger: #f85149;
			--success: #2ea043;
		}

		body { background: var(--bg); color: var(--text); font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; -webkit-font-smoothing: antialiased; }
		* { box-sizing: border-box; }

		nav { 
			display: flex; 
			justify-content: space-between; 
			align-items: center; 
			padding: 15px 20px; 
			border-bottom: 1px solid var(--border); 
			background: var(--card);
			position: sticky;
			top: 0;
			z-index: 100;
		}
		.logo { color: var(--accent); font-weight: 800; font-size: 20px; text-decoration: none; letter-spacing: -0.5px; }
		.nav-items { display: flex; align-items: center; }
		.nav-items a { 
			color: var(--text); text-decoration: none; margin-left: 20px; font-size: 14px; cursor: pointer; transition: 0.2s; 
		}
		.nav-items a:hover { color: var(--accent); }
		.btn-login { background: var(--accent); color: #000 !important; padding: 8px 16px; border-radius: 6px; font-weight: 700; }

		.container { 
			max-width: 1000px; 
			margin: 0 auto; 
			padding: 20px; 
			width: 100%;
		}
		.section { display: none; animation: fadeIn 0.3s ease-out; }
		.active-section { display: block; }

		.table-wrap { 
			overflow-x: auto;
			background: var(--card); 
			border-radius: 8px; 
			border: 1px solid var(--border); 
			margin-top: 15px; 
			-webkit-overflow-scrolling: touch;
		}
		table { width: 100%; border-collapse: collapse; min-width: 600px;}
		
		th { text-align: left; padding: 12px 16px; color: var(--dim); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; }
		td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; white-space: nowrap; /* Prevent numbers splitting */ }
		
		.price-cell { font-family: 'Monaco', 'Consolas', monospace; font-weight: 600; color: white; text-align: right; }
		.brand-badge { background: rgba(251, 191, 36, 0.1); color: var(--accent); padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
		.time-badge { font-size: 11px; color: var(--dim); display: flex; align-items: center; gap: 5px; }

		.auth-box { 
			width: 100%; 
			max-width: 350px; 
			margin: 40px auto; 
			background: var(--card); 
			padding: 2rem; 
			border-radius: 12px; 
			border: 1px solid var(--border); 
		}
		input { 
			width: 100%; 
			padding: 14px;
			margin: 8px 0; 
			background: #0d1117; 
			border: 1px solid var(--border); 
			color: white; 
			border-radius: 6px; 
			font-size: 16px;
		}
		button { 
			width: 100%; 
			padding: 14px;
			margin-top: 15px; 
			background: var(--accent); 
			border: none; 
			font-weight: 700; 
			cursor: pointer; 
			border-radius: 6px; 
			font-size: 14px;
			color: #05070a;
		}
		button:active { opacity: 0.9; transform: scale(0.98); }

		@media (max-width: 600px) {
			nav { flex-direction: column; gap: 15px; padding: 15px; }
			.nav-items { width: 100%; justify-content: space-between; }
			.nav-items a { margin: 0; font-size: 13px; }

			th, td { padding: 10px 12px; font-size: 13px; }
			.brand-badge { padding: 2px 6px; font-size: 10px; }

			.container { padding: 15px; }
			.auth-box { padding: 1.5rem; border: none; background: transparent; }
		}

		@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
	</style>
</head>
<body>

	<nav>
		<a href="#" class="logo" onclick="showPage('market')">NTGold</a>
		<div class="nav-items" id="nav-menu">
		</div>
	</nav>

	<div class="container">
		
		<div id="page-market" class="section active-section">
			<div style="display:flex; justify-content:space-between; align-items:center;">
				<h3>Today's Market Prices</h3>
				<span style="font-size:12px; color:var(--dim)">Live Updates</span>
			</div>
			
			<div class="table-wrap">
				<table>
					<thead>
						<tr>
							<th>Brand</th>
							<th>Weight</th>
							<th style="text-align:right">Price</th>
							<th style="text-align:right">Buyback</th>
							<th style="text-align:right">Last Updated</th>
						</tr>
					</thead>
					<tbody id="price-table">
						<tr><td colspan="5" style="text-align:center; padding:20px">Loading market data...</td></tr>
					</tbody>
				</table>
			</div>
		</div>

		<div id="page-portfolio" class="section">
			<h3>My Portfolio</h3>
			<div style="padding: 40px; text-align: center; color: var(--dim); border: 1px dashed var(--border); border-radius: 8px;">
				<p>You have not added any gold assets yet.</p>
				<button style="width:auto; font-size:12px;">+ Add Transaction</button>
			</div>
		</div>

		<div id="page-auth" class="section">
			<div class="auth-box" id="login-box">
				<h2 style="color:var(--accent); text-align:center; margin-top:0">Sign In</h2>
				<form onsubmit="handleLogin(event)">
					<input type="email" id="l-email" placeholder="Email" required autocomplete="email">
					<input type="password" id="l-password" placeholder="Password" required autocomplete="current-password">
					<button type="submit">Login</button>
				</form>

				<p id="l-error" style="color:var(--danger); font-size:12px; display:none; text-align:center; margin-top:10px"></p>
				<p style="text-align:center; font-size:12px; cursor:pointer; color:var(--dim); margin-top:15px" onclick="toggleAuthMode()">
					Need an account? Register
				</p>
			</div>
			
			<div class="auth-box" id="register-box" style="display:none">
				<h2 style="color:var(--accent); text-align:center; margin-top:0">Register</h2>
				<input type="text" id="r-name" placeholder="Full Name">
				<input type="email" id="r-email" placeholder="Email">
				<input type="password" id="r-password" placeholder="Password">
				<button onclick="handleRegister()">Create Account</button>
				<p id="r-error" style="color:var(--danger); font-size:12px; display:none; text-align:center;"></p>
				<p style="text-align:center; font-size:12px; cursor:pointer; color:var(--dim)" onclick="toggleAuthMode()">Have an account? Login</p>
			</div>
		</div>

	</div>

<script>
	const SUPABASE_URL = "https://iwsacljessokrqhfmdbv.supabase.co"; 
	const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3c2FjbGplc3Nva3JxaGZtZGJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxODcyNTMsImV4cCI6MjA4Mzc2MzI1M30.jQ_8KR76Xbbn1Heest75p3I78J6oiSt9V-H31cWWLOo";
	const { createClient } = supabase;
	const sbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

	window.onload = async () => {
		fetchLatestPrices();

		const { data: { session } } = await sbClient.auth.getSession();
		updateUIForAuth(session);

		sbClient.auth.onAuthStateChange((event, session) => {
			updateUIForAuth(session);
		});
	};

	function updateUIForAuth(session) {
		const nav = document.getElementById('nav-menu');
		if (session) {
			const email = session.user.email;
			nav.innerHTML = `
				<a onclick="showPage('market')">Market</a>
				<a onclick="showPage('portfolio')">My Portfolio</a>
				<a onclick="handleLogout()" style="color:var(--danger)">Logout</a>
			`;
		} else {
			nav.innerHTML = `
				<a onclick="showPage('market')">Market</a>
				<a onclick="showPage('auth')" class="btn-login">Login</a>
			`;
		}
	}

	function showPage(pageId) {
		document.querySelectorAll('.section').forEach(el => el.classList.remove('active-section'));
		document.getElementById(`page-${pageId}`).classList.add('active-section');
	}

	function toggleAuthMode() {
		const login = document.getElementById('login-box');
		const reg = document.getElementById('register-box');
		if (login.style.display === 'none') {
			login.style.display = 'block'; reg.style.display = 'none';
		} else {
			login.style.display = 'none'; reg.style.display = 'block';
		}
	}

	async function fetchLatestPrices() {
		const dateLimit = new Date();
		dateLimit.setDate(dateLimit.getDate() - 5);
		const dateLimitStr = dateLimit.toISOString().split('T')[0];

		let { data, error } = await sbClient
			.from('tblpricelog')
			.select(`
				price, buyback_price, weight_grams, log_date, created_date,
				tblbrand ( brand_name, brand_code ) 
			`)
			.gt('log_date', dateLimitStr) 
			.order('log_date', { ascending: false });

		const tbody = document.getElementById('price-table');
		
		if (error || !data || data.length === 0) {
			tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:var(--dim)">No recent data.</td></tr>`;
			return;
		}

		const uniqueMap = new Map();
		data.forEach(item => {
			const key = `${item.tblbrand?.brand_code}_${item.weight_grams}`;
			if (!uniqueMap.has(key)) uniqueMap.set(key, item);
		});
		
		const latestData = Array.from(uniqueMap.values()).sort((a, b) => {
			const brandA = a.tblbrand?.brand_name || "";
			const brandB = b.tblbrand?.brand_name || "";
			if (brandA !== brandB) return brandA.localeCompare(brandB);
			return a.weight_grams - b.weight_grams;
		});

		tbody.innerHTML = latestData.map(item => {
			const rawTime = item.created_date;

			const dateObj = new Date(rawTime);
			const todayObj = new Date();
			const isToday = dateObj.toDateString() === todayObj.toDateString();
			const dateColor = isToday ? 'var(--success)' : 'var(--danger)';
			const cleanTime = formatTimestamp(rawTime);

			return `
				<tr>
					<td><span class="brand-badge">${item.tblbrand?.brand_name}</span></td>
					<td>${item.weight_grams}g</td>
					<td class="price-cell">Rp ${item.price.toLocaleString('id-ID')}</td>
					<td class="price-cell" style="color:var(--dim)">Rp ${item.buyback_price.toLocaleString('id-ID')}</td>
					<td style="text-align:right">
						<div class="time-badge" style="justify-content:flex-end; color: ${dateColor}; font-weight:600;">
							${cleanTime}
						</div>
					</td>
				</tr>
			`;
		}).join('');
	}

	async function handleLogin(event) {
		if (event) event.preventDefault();

		const email = document.getElementById('l-email').value;
		const password = document.getElementById('l-password').value;
		const errEl = document.getElementById('l-error');

		errEl.style.display = 'none';

		const { error } = await sbClient.auth.signInWithPassword({ email, password });
		
		if (error) {
			errEl.innerText = error.message;
			errEl.style.display = 'block';
		} else {
			showPage('market'); 
		}
	}

	async function handleRegister() {
		const email = document.getElementById('r-email').value;
		const password = document.getElementById('r-password').value;
		const name = document.getElementById('r-name').value;
		const { error } = await sbClient.auth.signUp({ 
			email, password, options: { data: { full_name: name } } 
		});
		if (error) {
			document.getElementById('r-error').innerText = error.message;
			document.getElementById('r-error').style.display = 'block';
		} else {
			alert("Check email for verification!");
			toggleAuthMode();
		}
	}

	async function handleLogout() {
		await sbClient.auth.signOut();
		showPage('market');
	}

	function formatTimestamp(isoString) {
		if (!isoString) return "-";
		const date = new Date(isoString);
		
		if (isNaN(date.getTime())) return isoString;

		const day = String(date.getDate()).padStart(2, '0');
		const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
		const month = months[date.getMonth()];
		const year = date.getFullYear();
		
		const hours = String(date.getHours()).padStart(2, '0');
		const minutes = String(date.getMinutes()).padStart(2, '0');
		const seconds = String(date.getSeconds()).padStart(2, '0');

		return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
	}

</script>
</body>
</html>